_comment: "DO NOT EDIT: FILE GENERATED AUTOMATICALLY BY PANEL"
meta:
  version: PLCN_v3
  update_url: https://raw.githubusercontent.com/ritinae/pelican-eggs/refs/heads/main/egg-valheim-bep-in-ex.yamlnull
exported_at: "2026-01-06T10:26:00+02:00"
name: "Valheim BepInEx (Modified)"
author: inari@jakojaannos.fi
uuid: 88849bb4-9b6c-4494-bf4a-15bf2bb69ec5
description: |-
  A brutal exploration and survival game for 1-10 players, set in a procedurally-generated purgatory
  inspired by viking culture incl the Plugin Framework BepInEx
  Egg install script modified for (hopefully) more correct mod extraction behavior. The original
  install script does not extract assets/configuration files correctly.
image: null
tags:
  - "Tein itse ja säästin"
features:
  - steam_disk_space
docker_images:
  "ghcr.io/parkervcp/games:valheim": "ghcr.io/parkervcp/games:valheim"
file_denylist: {}
startup_commands:
  Default: 'export DOORSTOP_ENABLED=1; export DOORSTOP_TARGET_ASSEMBLY=./BepInEx/core/BepInEx.Preloader.dll; export LD_LIBRARY_PATH="./doorstop_libs:./linux64:$LD_LIBRARY_PATH"; export LD_PRELOAD="libdoorstop_x64.so:$LD_PRELOAD"; export LD_LIBRARY_PATH="./linux64:$LD_LIBRARY_PATH"; export SteamAppId=892970; ./valheim_server.x86_64 -nographics -batchmode -name "{{SERVER_NAME}}" -port {{SERVER_PORT}} -world "{{WORLD}}" -password "{{PASSWORD}}" -public {{PUBLIC_SERVER}} -saveinterval {{BACKUP_INTERVAL}} -backups {{BACKUP_COUNT}} -backupshort {{BACKUP_SHORTTIME}} -backuplong {{BACKUP_LONGTIME}} $( [[ {{ENABLE_CROSSPLAY}} -eq 1 ]] && echo " -crossplay ") > >(sed -uE "{{CONSOLE_FILTER}}") & trap "{{STOP}}" 15; wait $!'
config:
  files: {}
  startup:
    done: "Game server connected"
  logs: {}
  stop: ^C
scripts:
  installation:
    script: |
      #! /usr/bin/env bash
      apt update -y
      apt install \
      	-y \
      	--no-install-recommends \
      	--no-install-suggests \
      	wget jq
      
      if [ "$STEAM_USER" == "" ]; then
      	echo "steam user is not set."
      	echo "Using anonymous user."
      	: "${STEAM_USER:=anonymous}"
      	: "${STEAM_PASS:=}"
      	: "${STEAM_AUTH:=}"
      else
      	echo "user set to $STEAM_USER"
      fi
      
      ## download and install steamcmd
      mkdir -p /mnt/server/steamcmd
      curl -sSL -o /tmp/steamcmd.tar.gz https://steamcdn-a.akamaihd.net/client/installer/steamcmd_linux.tar.gz
      tar -xzvf /tmp/steamcmd.tar.gz -C /mnt/server/steamcmd
      
      cd /mnt/server/steamcmd || exit 1
      
      # SteamCMD fails otherwise for some reason, even running as root.
      # This is changed at the end of the install process anyways.
      chown -R root:root /mnt
      export HOME=/mnt/server
      
      ## install game using steamcmd
      ./steamcmd.sh \
      	+force_install_dir \
      	/mnt/server \
      	+login "$STEAM_USER" "$STEAM_PASS" "$STEAM_AUTH" \
      	+app_update 896660 \
      	+quit
      
      ## set up libraries for steam client
      mkdir -p /mnt/server/.steam/sdk{32,64}
      cp -v linux32/steamclient.so ../.steam/sdk32/steamclient.so
      cp -v linux64/steamclient.so ../.steam/sdk64/steamclient.so
      
      echo "-------------------------------------------------------"
      echo "installing BepInEx and Selected ModPacks..."
      echo "-------------------------------------------------------"
      
      cd /mnt/server || exit 1
      
      BEPINEX_URL="https://thunderstore.io/api/experimental/package/denikson/BepInExPack_Valheim/"
      if ! BEPINEX_MANIFEST=$(curl -sfSL -H "accept: application/json" "$BEPINEX_URL"); then
      	echo "Error: could not retrieve BepInEx release info from Thunderstore.io API"
      	exit 1
      fi
      
      DOWNLOAD_MIRROR="https://thunderstore.io/package/download"
      PLUGIN_DIR="/mnt/server/BepInEx/plugins"
      CONFIG_DIR="/mnt/server/BepInEx/config"
      DOWNLOAD_DIR="/mnt/server/tmp_dl"
      
      BEPINEX_MOD_URL=$(jq -r  ".latest.download_url" <<< "$BEPINEX_MANIFEST" )
      BEPINEX_MOD="denikson-BepInExPack_Valheim"
      BEPINEX_INSTALL_DIR="/mnt/server"
      
      # Ensure directories exist
      mkdir -p "$BEPINEX_INSTALL_DIR" "$DOWNLOAD_DIR" "$PLUGIN_DIR" "$CONFIG_DIR"
      
      wget --content-disposition -O "$DOWNLOAD_DIR/$BEPINEX_MOD.zip" "$BEPINEX_MOD_URL"
      unzip -o "$DOWNLOAD_DIR/$BEPINEX_MOD.zip" -d "$DOWNLOAD_DIR"
      
      cp -rf "$DOWNLOAD_DIR/BepInExPack_Valheim/"{doorstop_config.ini,doorstop_libs,BepInEx,winhttp.dll} "$BEPINEX_INSTALL_DIR/"
      cp -rf "$DOWNLOAD_DIR/BepInExPack_Valheim/BepInEx" "$BEPINEX_INSTALL_DIR/"
      
      
      if [ ! -z "$V_MODPACK" ]; then
      	#Modpack Name dashes to slashes for URL
      	MODPACK_URL=$(echo "$V_MODPACK" | sed 's/-/\//g')
      
      	# Download and extract modpack. The modpack itself may technically contain
      	# assets/overrides, so it is safest to place it inside the plugin dir.
      	wget -O "$DOWNLOAD_DIR/$V_MODPACK.zip" "$DOWNLOAD_MIRROR/$MODPACK_URL"
      	unzip -o "$DOWNLOAD_DIR/$V_MODPACK.zip" -d "$PLUGIN_DIR/$V_MODPACK"
      
      	#Extract dependencies from ModPack JSON manifest
      	MODPACK_DEPS=$(cat "$PLUGIN_DIR/$V_MODPACK/manifest.json" | jq -r '.dependencies[]')
      
      	for MOD in $MODPACK_DEPS; do
      		# Ignore BepInEx, it was already installed
      		if [[ "$MOD" == *"denikson-BepInExPack_Valheim"* ]]; then
      			continue
      		fi
      
      		# Dowload and extract. Extract all files, as e.g. asset bundles may need
      		# to be present within the plugin directories.
      		MOD_URL=$(echo "$MOD" | sed 's/-/\//g')
      		MOD_DIR="$PLUGIN_DIR/$MOD"
      		wget -O "$DOWNLOAD_DIR/$MOD.zip" "$DOWNLOAD_MIRROR/$MOD_URL"
      		rm -rf "${MOD_DIR:?}"
      		unzip -o "$DOWNLOAD_DIR/$MOD.zip" -d "$MOD_DIR"
      
      		# Install mod configs
      		if [ -d "$MOD_DIR/config" ]; then
      			cp -rf "$MOD_DIR/config" "/mnt/server/BepInEx"
      		# HACK: funky casing on some mods
      		elif [ -d "$PLUGIN_DIR/$V_MODPACK/Config" ]; then
      			cp -rf -t "$PLUGIN_DIR/$V_MODPACK/config" "$PLUGIN_DIR/$V_MODPACK/Config/*"
      		fi
      	done
      
      	# Install modpack configs last to make sure the modpack can override any
      	# files extracted from other mods.
      	if [ -d "$PLUGIN_DIR/$V_MODPACK/config" ]; then
      		cp -rf "$PLUGIN_DIR/$V_MODPACK/config" "/mnt/server/BepInEx"
      	# HACK: funky casing on some mods
      	elif [ -d "$PLUGIN_DIR/$V_MODPACK/Config" ]; then
      		cp -rf -t "$PLUGIN_DIR/$V_MODPACK/config" "$PLUGIN_DIR/$V_MODPACK/Config/*"
      	fi
      fi
      
      echo "-------------------------------------------------------"
      echo "Cleaning up..."
      echo "-------------------------------------------------------"
      
      rm -rf "${DOWNLOAD_DIR:?}"
      
      echo "-------------------------------------------------------"
      echo "Installation completed"
      echo "-------------------------------------------------------"
    container: "ghcr.io/parkervcp/installers:debian"
    entrypoint: bash
variables:
  - name: "Auto Update"
    description: ""
    env_variable: AUTO_UPDATE
    default_value: 1
    user_viewable: true
    user_editable: true
    rules:
      - boolean
    sort: 5
  - name: "Backup Count"
    description: |-
      Sets how many automatic backups will be kept. The first is the 'short' backup length, and the rest
      are the 'long' backup length. When default values are used means one backup that is 2 hours old, and
      3 backups that are 12 hours apart. Default: 4.
    env_variable: BACKUP_COUNT
    default_value: 4
    user_viewable: true
    user_editable: true
    rules:
      - required
      - numeric
      - "min:0"
    sort: 10
  - name: "Backup Interval"
    description: "Change how often the world will save in seconds. Default: 1800 (30 minutes)."
    env_variable: BACKUP_INTERVAL
    default_value: 1800
    user_viewable: true
    user_editable: true
    rules:
      - required
      - numeric
      - "min:0"
    sort: 9
  - name: "Backup Longtime"
    description: "Sets the interval between the subsequent automatic backups in seconds. Default: 43200 (12 hours)."
    env_variable: BACKUP_LONGTIME
    default_value: 43200
    user_viewable: true
    user_editable: true
    rules:
      - required
      - numeric
      - "min:0"
    sort: 12
  - name: "Backup Shorttime"
    description: "Sets the interval between the first automatic backups in seconds. Default: 7200 (2 hours)."
    env_variable: BACKUP_SHORTTIME
    default_value: 7200
    user_viewable: true
    user_editable: true
    rules:
      - required
      - numeric
      - "min:0"
    sort: 11
  - name: "Beta Branch"
    description: ""
    env_variable: SRCDS_BETAID
    default_value: ""
    user_viewable: true
    user_editable: true
    rules:
      - "max:30"
    sort: 7
  - name: "Beta Password"
    description: ""
    env_variable: SRCDS_BETAPASS
    default_value: ""
    user_viewable: true
    user_editable: true
    rules:
      - "max:30"
    sort: 8
  - name: "Enable Crossplay"
    description: "Enable crossplay support"
    env_variable: ENABLE_CROSSPLAY
    default_value: 0
    user_viewable: true
    user_editable: true
    rules:
      - boolean
    sort: 6
  - name: ModPack
    description: |-
      Enter the Dependency String name for a ModPack to automatically be installed. The name must be in
      the full `author-ModPackName-1.2.3` -format.
      CHANGING THIS REQUIRES A SERVER REINSTALL
    env_variable: V_MODPACK
    default_value: ""
    user_viewable: true
    user_editable: true
    rules:
      - string
      - nullable
    sort: 13
  - name: "Public Server"
    description: ""
    env_variable: PUBLIC_SERVER
    default_value: 0
    user_viewable: true
    user_editable: true
    rules:
      - boolean
    sort: 4
  - name: "Server Name"
    description: "Name that appears in server browser."
    env_variable: SERVER_NAME
    default_value: "My Server"
    user_viewable: true
    user_editable: true
    rules:
      - required
      - string
      - "max:60"
    sort: 1
  - name: "Server Password"
    description: "Server password."
    env_variable: PASSWORD
    default_value: kissa123
    user_viewable: true
    user_editable: true
    rules:
      - required
      - string
      - "min:5"
      - "max:20"
    sort: 2
  - name: "World Name"
    description: "Name to load if switching between multiple saved worlds."
    env_variable: WORLD
    default_value: Dedicated
    user_viewable: true
    user_editable: true
    rules:
      - required
      - string
      - "max:20"
    sort: 3
  - name: "[System] App ID"
    description: "Valheim steam app id for auto updates."
    env_variable: SRCDS_APPID
    default_value: 896660
    user_viewable: true
    user_editable: false
    rules:
      - nullable
      - numeric
    sort: 15
  - name: "[System] Console Filter"
    description: "Remove unwanted outputs from the console."
    env_variable: CONSOLE_FILTER
    default_value: '/^\(Filename:.*Line:[[:space:]]+[[:digit:]]+\)$/d; /^([[:space:]]+)?$/d'
    user_viewable: false
    user_editable: false
    rules:
      - string
    sort: 14
  - name: "[System] LD Library Path"
    description: "Required to load server libraries."
    env_variable: LD_LIBRARY_PATH
    default_value: ./linux64
    user_viewable: false
    user_editable: false
    rules:
      - required
      - string
    sort: 16
  - name: "[System] Shutdown Command"
    description: ""
    env_variable: STOP
    default_value: "kill -2 $!; wait;"
    user_viewable: false
    user_editable: false
    rules:
      - required
      - string
      - "max:20"
    sort: 17
